<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BladeHunters Hub</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0b10;
      --card:#141423;
      --card2:#10101b;
      --text:#f4f4fb;
      --muted:#a0a0b7;
      --line:rgba(255,255,255,.08);
      --red:#ff1c1c;
      --red2:#e10600;
      --good:#27d18a;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 40% -10%, rgba(255,28,28,.18), transparent 55%),
                 radial-gradient(900px 500px at 85% 0%, rgba(255,28,28,.12), transparent 60%),
                 var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .wrap{max-width:720px;margin:0 auto;padding:16px 14px 110px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;border:1px solid var(--line);border-radius:22px;background:rgba(20,20,35,.72);backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:10;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(255,28,28,.95), rgba(225,6,0,.75));
      box-shadow: 0 10px 25px rgba(255,28,28,.22);
      display:grid;place-items:center;
      font-weight:900; letter-spacing:.5px;
    }
    .brand h1{font-size:15px;margin:0;line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(16,16,27,.65);
      color:var(--muted); font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good)}
    .grid{display:grid;gap:12px;margin-top:14px}
    .card{
      border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(20,20,35,.88), rgba(16,16,27,.86));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 14px 8px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .ttl{margin:0;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .card .bd{padding:0 14px 14px}
    .stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .stat{
      padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(10,10,18,.55);
    }
    .stat .n{font-size:18px;font-weight:900}
    .stat .t{font-size:11px;color:var(--muted);margin-top:2px}
    .btn{
      width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,28,28,.08); color:var(--text); font-weight:800;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(135deg, rgba(255,28,28,.98), rgba(225,6,0,.86));
      border-color: rgba(255,28,28,.35);
      box-shadow: 0 16px 30px rgba(255,28,28,.18);
    }
    .btn.ghost{background:rgba(255,255,255,.04)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .row{display:flex;gap:10px}
    .row .btn{flex:1}
    label{display:block;margin-top:10px;font-size:12px;color:var(--muted)}
    input, select{
      width:100%; padding:12px 12px;
      border-radius:14px;border:1px solid var(--line);
      background:rgba(10,10,18,.55); color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(255,28,28,.55)}
    .nav{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(10,10,16,.75);backdrop-filter: blur(12px);
      border-top:1px solid var(--line);
      padding:10px 14px 20px;
    }
    .tabs{max-width:720px;margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .tab{
      padding:10px 10px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--muted);
      font-size:12px; text-align:center; cursor:pointer; user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(255,28,28,.35);
      background:rgba(255,28,28,.08);
      box-shadow: 0 10px 25px rgba(255,28,28,.10);
    }
    .list{display:grid;gap:10px;margin-top:10px}
    .item{
      padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(10,10,18,.55);
      display:grid;gap:6px;
    }
    .item .topline{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .item .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .tag{padding:6px 9px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:11px;color:var(--muted)}
    a{color:#ffd5d5;text-decoration:none}
    a:hover{text-decoration:underline}
    .small{font-size:12px}
    .kpi{font-weight:900}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:110px; background:rgba(20,20,35,.92);
      border:1px solid var(--line);
      padding:10px 12px;border-radius:999px;
      display:none; gap:8px; align-items:center;
      box-shadow: var(--shadow);
      max-width:90%;
    }
    .toast.show{display:flex}
    .toast .b{width:8px;height:8px;border-radius:50%;background:var(--good)}
    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;padding:12px;z-index:50}
    .modalBack.show{display:flex}
    .modal{
      width:min(720px, 100%);
      background:linear-gradient(180deg, rgba(20,20,35,.98), rgba(12,12,20,.98));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mh{padding:14px 14px 10px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .x{width:38px;height:38px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);cursor:pointer}
    .modal .mb{padding:0 14px 14px}
    .danger{background:rgba(255,28,28,.10);border-color:rgba(255,28,28,.35)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">BH</div>
        <div>
          <h1>BladeHunters Hub</h1>
          <div class="sub" id="subline">SUP –¥–Ω–µ–≤–Ω–∏–∫ ‚Ä¢ –∫–æ–º–∞–Ω–¥–∞ ‚Ä¢ —Ä–µ–π—Ç–∏–Ω–≥–∏</div>
        </div>
      </div>
      <div class="pill"><span class="dot"></span><span id="status">offline</span></div>
    </div>

    <div id="view"></div>
  </div>

  <div class="nav">
    <div class="tabs">
      <div class="tab active" data-tab="home">–ì–ª–∞–≤–Ω–∞—è</div>
      <div class="tab" data-tab="add">–î–æ–±–∞–≤–∏—Ç—å</div>
      <div class="tab" data-tab="board">–†–µ–π—Ç–∏–Ω–≥</div>
      <div class="tab" data-tab="me">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
  </div>

  <div class="toast" id="toast"><span class="b"></span><span id="toastText">–û–∫</span></div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="mh">
        <div>
          <div class="ttl" id="modalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</div>
          <div class="muted small">–ú–µ–Ω—è–π –¥–∞–Ω–Ω—ã–µ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–π</div>
        </div>
        <button class="x" onclick="closeModal()">‚úï</button>
      </div>
      <div class="mb" id="modalBody"></div>
    </div>
  </div>

<script>
  // ===== –ù–ê–°–¢–†–û–ô–ö–ê API =====
  // –ï—Å–ª–∏ backend –±—É–¥–µ—Ç –Ω–∞ Render ‚Äî –ø–æ–º–µ–Ω—è–π —Ç—É—Ç URL –Ω–∞ —Å–≤–æ–π https://...
  const API_URL = "http://localhost:3000";

  // ===== Telegram =====
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  // ===== State =====
  const state = {
    tab: "home",
    token: localStorage.getItem("bh_token") || null,
    team: localStorage.getItem("bh_team") || "Blade Hunters",
    user: null,
    me: null,
    trainings: [],
    leaderboards: null,
  };

  // ===== Helpers =====
  function $(sel){ return document.querySelector(sel); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function toast(msg){ $("#toastText").textContent = msg; $("#toast").classList.add("show"); setTimeout(()=>$("#toast").classList.remove("show"), 2200); }
  function fmtDate(iso){ try { return new Date(iso).toLocaleString(); } catch { return iso; } }
  function paceLabel(sec){
    if(!sec || sec<=0) return "‚Äî";
    const m = Math.floor(sec/60), s = sec%60;
    return `${m}:${String(s).padStart(2,'0')} /–∫–º`;
  }
  function authHeaders(){
    return state.token ? { "Authorization": "Bearer " + state.token } : {};
  }

  async function api(path, opts={}){
    const res = await fetch(API_URL + path, {
      ...opts,
      headers: { "Content-Type": "application/json", ...(opts.headers||{}), ...authHeaders() }
    });
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = { raw: txt }; }
    if(!res.ok) throw new Error(data?.error || txt || ("HTTP " + res.status));
    return data;
  }

  async function checkHealth(){
    try{
      const r = await fetch(API_URL + "/health");
      const j = await r.json();
      $("#status").textContent = j.ok ? "online" : "offline";
      $(".dot").style.background = j.ok ? "var(--good)" : "var(--red)";
    }catch(e){
      $("#status").textContent = "offline";
      $(".dot").style.background = "var(--red)";
    }
  }

  // ===== Auth flow =====
  async function ensureAuth(){
    // Read Telegram user (if inside Telegram). If not ‚Äî allow demo mode.
    const u = tg?.initDataUnsafe?.user || null;
    state.user = u;

    if(!state.token){
      renderLogin();
      return false;
    }
    return true;
  }

  async function doLogin(){
    const team = $("#team").value.trim() || "Blade Hunters";
    state.team = team;
    localStorage.setItem("bh_team", team);

    const u = tg?.initDataUnsafe?.user;
    if(!u){
      toast("–û—Ç–∫—Ä–æ–π –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª–∞.");
      return;
    }
    const payload = {
      telegram_id: u.id,
      username: u.username || null,
      first_name: u.first_name || null,
      last_name: u.last_name || null,
      photo_url: u.photo_url || null,
      team
    };
    const r = await api("/auth", { method:"POST", body: JSON.stringify(payload), headers: {} });
    state.token = r.token;
    localStorage.setItem("bh_token", r.token);
    toast("–¢—ã –≤–Ω—É—Ç—Ä–∏ ‚úÖ");
    await loadAll();
    render();
  }

  function logout(){
    localStorage.removeItem("bh_token");
    state.token = null;
    state.me = null;
    state.trainings = [];
    state.leaderboards = null;
    toast("–í—ã—à–µ–ª");
    renderLogin();
  }

  // ===== Data loads =====
  async function loadAll(){
    await Promise.all([loadMe(), loadTrainings(), loadLeaderboards()]);
  }
  async function loadMe(){
    state.me = await api("/me");
  }
  async function loadTrainings(){
    const r = await api("/trainings");
    state.trainings = r.trainings || [];
  }
  async function loadLeaderboards(){
    const r = await api("/leaderboards/weekly?team=" + encodeURIComponent(state.team));
    state.leaderboards = r;
  }

  // ===== UI render =====
  function setTab(tab){
    state.tab = tab;
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
    render();
  }

  function renderLogin(){
    const u = tg?.initDataUnsafe?.user;
    const name = u ? `${u.first_name||""} ${u.last_name||""}`.trim() : "–ì–æ—Å—Ç—å (–Ω–µ Telegram)";
    const uname = u?.username ? "@"+u.username : "‚Äî";
    $("#view").innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</div>
              <div class="muted">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</div>
            </div>
            <span class="tag">v2</span>
          </div>
          <div class="bd">
            <div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</div>
            <div style="margin-top:6px;font-weight:900">${esc(name)}</div>
            <div class="muted small">${esc(uname)}</div>

            <label>–ö–æ–º–∞–Ω–¥–∞</label>
            <input id="team" value="${esc(state.team)}" placeholder="Blade Hunters" />

            <div class="row" style="margin-top:12px">
              <button class="btn primary" onclick="doLogin()">–í–æ–π—Ç–∏</button>
              <button class="btn ghost" onclick="checkHealth().then(()=>toast('–ü—Ä–æ–≤–µ—Ä–∏–ª —Å–µ—Ä–≤–µ—Ä'))">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
            </div>

            <div class="hr"></div>
            <div class="muted small">
              –ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å offline ‚Äî –∑–Ω–∞—á–∏—Ç backend –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –¥—Ä—É–≥–æ–π URL.<br/>
              –î–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –æ—Ç–∫—Ä–æ–π Mini App –≤–Ω—É—Ç—Ä–∏ Telegram.
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderHome(){
    const me = state.me;
    const name = state.user ? `${state.user.first_name||""} ${state.user.last_name||""}`.trim() : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
    const totalKm = me?.stats?.total_km ?? 0;
    const trainings = me?.stats?.trainings ?? 0;
    const hours = me?.stats?.total_hours ?? 0;

    const last3 = (state.trainings || []).slice(0,3).map(t => `
      <div class="item">
        <div class="topline">
          <div class="kpi">${esc(fmtDate(t.started_at))}</div>
          <span class="tag">${esc(t.distance_km)} –∫–º</span>
        </div>
        <div class="meta">
          <span>‚è± ${esc(t.duration_min)} –º–∏–Ω</span>
          <span>‚ö° ${esc(t.avg_speed_kmh)} –∫–º/—á</span>
          ${t.avg_hr ? `<span>‚ù§ ${esc(t.avg_hr)}</span>` : ""}
          <span>üèÅ ${esc(paceLabel(t.pace_sec_per_km))}</span>
        </div>
        <div class="small"><a href="${esc(t.track_url)}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–∫</a></div>
      </div>
    `).join("");

    $("#view").innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–ü—Ä–∏–≤–µ—Ç, ${esc(name)} üëã</div>
              <div class="muted">–ö–æ–º–∞–Ω–¥–∞: <b>${esc(state.team)}</b></div>
            </div>
            <button class="x" onclick="logout()" title="–í—ã–π—Ç–∏">‚éã</button>
          </div>
          <div class="bd">
            <div class="stats">
              <div class="stat"><div class="n">${esc(totalKm)}</div><div class="t">–∫–º –≤—Å–µ–≥–æ</div></div>
              <div class="stat"><div class="n">${esc(trainings)}</div><div class="t">—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
              <div class="stat"><div class="n">${esc(hours)}</div><div class="t">—á–∞—Å–æ–≤</div></div>
            </div>
            <div style="margin-top:12px">
              <button class="btn primary" onclick="setTab('add')">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
              <div class="muted">3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–∏</div>
            </div>
            <span class="tag">–ò—Å—Ç–æ—Ä–∏—è</span>
          </div>
          <div class="bd">
            <div class="list">${last3 || `<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É.</div>`}</div>
          </div>
        </div>
      </div>
    `;
  }

  function renderAdd(){
    const nowLocal = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    const localDT = `${nowLocal.getFullYear()}-${pad(nowLocal.getMonth()+1)}-${pad(nowLocal.getDate())}T${pad(nowLocal.getHours())}:${pad(nowLocal.getMinutes())}`;

    $("#view").innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</div>
              <div class="muted">–ü—Ä–æ—Å—Ç–æ, –±–µ–∑ —Å–ø–æ—Ä–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤</div>
            </div>
            <span class="tag">SUP</span>
          </div>
          <div class="bd">
            <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
            <input id="f_started" type="datetime-local" value="${localDT}" />

            <div class="row">
              <div style="flex:1">
                <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</label>
                <input id="f_km" inputmode="decimal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 7.5" />
              </div>
              <div style="flex:1">
                <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
                <input id="f_min" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 55" />
              </div>
            </div>

            <div class="row">
              <div style="flex:1">
                <label>–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)</label>
                <input id="f_spd" inputmode="decimal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 8.2" />
              </div>
              <div style="flex:1">
                <label>–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å (–æ–ø—Ü.)</label>
                <input id="f_hr" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 142" />
              </div>
            </div>

            <label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–µ–∫ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input id="f_url" placeholder="https://..." />

            <div style="margin-top:12px">
              <button class="btn primary" onclick="submitTraining()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <div class="muted small" style="margin-top:8px">
                –í–∞–∂–Ω–æ: —Å—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http/https ‚Äî –∏–Ω–∞—á–µ –∑–∞–ø–∏—Å—å –Ω–µ –ø—Ä–∏–º–µ—Ç—Å—è.
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–ò—Å—Ç–æ—Ä–∏—è</div>
              <div class="muted">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ</div>
            </div>
            <span class="tag">CRUD</span>
          </div>
          <div class="bd" id="historyBox"></div>
        </div>
      </div>
    `;
    renderHistoryInto("#historyBox");
  }

  function renderHistoryInto(sel){
    const box = document.querySelector(sel);
    const items = state.trainings || [];
    box.innerHTML = items.length ?
      `<div class="list">` + items.map(t => `
        <div class="item">
          <div class="topline">
            <div class="kpi">${esc(fmtDate(t.started_at))}</div>
            <div style="display:flex;gap:8px">
              <button class="x" onclick="openEdit('${esc(t.id)}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
              <button class="x danger" onclick="removeTraining('${esc(t.id)}')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
            </div>
          </div>
          <div class="meta">
            <span>üìè ${esc(t.distance_km)} –∫–º</span>
            <span>‚è± ${esc(t.duration_min)} –º–∏–Ω</span>
            <span>‚ö° ${esc(t.avg_speed_kmh)} –∫–º/—á</span>
            ${t.avg_hr ? `<span>‚ù§ ${esc(t.avg_hr)}</span>` : ""}
            <span>üèÅ ${esc(paceLabel(t.pace_sec_per_km))}</span>
          </div>
          <div class="small"><a href="${esc(t.track_url)}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–∫</a></div>
        </div>
      `).join("") + `</div>`
      : `<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –≤—ã—à–µ.</div>`;
  }

  function renderBoard(){
    const lb = state.leaderboards;
    const ws = lb?.week_start ? new Date(lb.week_start).toLocaleDateString() : "‚Äî";
    const we = lb?.week_end ? new Date(lb.week_end).toLocaleDateString() : "‚Äî";

    function rowUser(u, extra){
      const name = `${u.first_name||""} ${u.last_name||""}`.trim() || (u.username ? "@"+u.username : "–ë–µ–∑ –∏–º–µ–Ω–∏");
      const uname = u.username ? "@"+u.username : "";
      return `
        <div class="item">
          <div class="topline">
            <div>
              <div class="kpi">${esc(name)}</div>
              <div class="muted small">${esc(uname)} ‚Ä¢ ${esc(u.team||"")}</div>
            </div>
            ${extra}
          </div>
        </div>
      `;
    }

    const kmTop = (lb?.kmTop || []).map((u, i) =>
      rowUser(u, `<span class="tag">#${i+1} ‚Ä¢ <b>${esc(u.total_km)}</b> –∫–º</span>`)
    ).join("");

    const paceTop = (lb?.paceTop || []).map((u, i) =>
      rowUser(u, `<span class="tag">#${i+1} ‚Ä¢ <b>${esc(paceLabel(u.best_pace_sec_per_km))}</b></span>`)
    ).join("");

    $("#view").innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–†–µ–π—Ç–∏–Ω–≥ –Ω–µ–¥–µ–ª–∏</div>
              <div class="muted">${esc(ws)} ‚Üí ${esc(we)} ‚Ä¢ —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–∞–Ω–¥–µ</div>
            </div>
            <span class="tag">${esc(state.team)}</span>
          </div>
          <div class="bd">
            <label>–ö–æ–º–∞–Ω–¥–∞ (—Ñ–∏–ª—å—Ç—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞)</label>
            <input id="team2" value="${esc(state.team)}" />
            <div class="row" style="margin-top:10px">
              <button class="btn primary" onclick="applyTeam()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
              <button class="btn ghost" onclick="refreshBoard()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–¢–û–ü ‚Äî –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂</div>
              <div class="muted">—Å—É–º–º–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
            <span class="tag">–∫–º</span>
          </div>
          <div class="bd">
            <div class="list">${kmTop || `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>`}</div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–¢–û–ü ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ç–µ–º–ø</div>
              <div class="muted">–ª—É—á—à–∏–π —Ç–µ–º–ø –∑–∞ –Ω–µ–¥–µ–ª—é (–ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º)</div>
            </div>
            <span class="tag">—Ç–µ–º–ø</span>
          </div>
          <div class="bd">
            <div class="list">${paceTop || `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>`}</div>
          </div>
        </div>
      </div>
    `;
  }

  function renderMe(){
    const me = state.me;
    const u = me?.user;
    const s = me?.stats;
    const name = `${u?.first_name||""} ${u?.last_name||""}`.trim() || "‚Äî";
    const uname = u?.username ? "@"+u.username : "‚Äî";

    $("#view").innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="hd">
            <div>
              <div class="ttl">–ü—Ä–æ—Ñ–∏–ª—å</div>
              <div class="muted">–¢–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            </div>
            <span class="tag">me</span>
          </div>
          <div class="bd">
            <div style="display:flex;gap:12px;align-items:center">
              <div class="logo" style="width:54px;height:54px;border-radius:18px">BH</div>
              <div>
                <div class="kpi">${esc(name)}</div>
                <div class="muted small">${esc(uname)}</div>
                <div class="muted small">–ö–æ–º–∞–Ω–¥–∞: <b>${esc(u?.team||state.team)}</b></div>
              </div>
            </div>

            <div class="stats" style="margin-top:12px">
              <div class="stat"><div class="n">${esc(s?.total_km ?? 0)}</div><div class="t">–∫–º –≤—Å–µ–≥–æ</div></div>
              <div class="stat"><div class="n">${esc(s?.trainings ?? 0)}</div><div class="t">—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
              <div class="stat"><div class="n">${esc(s?.total_hours ?? 0)}</div><div class="t">—á–∞—Å–æ–≤</div></div>
            </div>

            <div class="hr"></div>

            <label>–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</label>
            <input id="team3" value="${esc(u?.team || state.team)}" />
            <div class="row" style="margin-top:10px">
              <button class="btn primary" onclick="applyTeamFromProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn ghost" onclick="setTab('home')">–ù–∞–∑–∞–¥</button>
            </div>

            <div class="hr"></div>
            <button class="btn danger" onclick="logout()">–í—ã–π—Ç–∏</button>
          </div>
        </div>
      </div>
    `;
  }

  function render(){
    if(!state.token){
      renderLogin();
      return;
    }
    if(state.tab === "home") return renderHome();
    if(state.tab === "add") return renderAdd();
    if(state.tab === "board") return renderBoard();
    if(state.tab === "me") return renderMe();
  }

  // ===== Actions =====
  async function submitTraining(){
    const startedLocal = $("#f_started").value;
    const km = $("#f_km").value.trim();
    const min = $("#f_min").value.trim();
    const spd = $("#f_spd").value.trim();
    const hr = $("#f_hr").value.trim();
    const url = $("#f_url").value.trim();

    // validations (no —Å–ø–æ—Ä–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤)
    if(!startedLocal) return toast("–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É/–≤—Ä–µ–º—è");
    if(!km || Number(km) <= 0) return toast("–£–∫–∞–∂–∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é (–∫–º) > 0");
    if(!min || Number(min) <= 0) return toast("–£–∫–∞–∂–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω) > 0");
    if(!spd || Number(spd) <= 0) return toast("–£–∫–∞–∂–∏ —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á) > 0");
    if(!url || !url.startsWith("http")) return toast("–ù—É–∂–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–µ–∫ (http/https)");

    const started = new Date(startedLocal).toISOString();
    const payload = {
      started_at: started,
      distance_km: Number(km),
      duration_min: Number(min),
      avg_speed_kmh: Number(spd),
      avg_hr: hr ? Number(hr) : null,
      track_url: url
    };
    try{
      await api("/trainings", { method:"POST", body: JSON.stringify(payload) });
      toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
      $("#f_km").value = "";
      $("#f_min").value = "";
      $("#f_spd").value = "";
      $("#f_hr").value = "";
      $("#f_url").value = "";
      await loadTrainings();
      await loadMe();
      renderAdd();
    }catch(e){
      toast("–û—à–∏–±–∫–∞: " + e.message);
    }
  }

  async function refreshBoard(){
    try{
      await loadLeaderboards();
      toast("–û–±–Ω–æ–≤–∏–ª");
      renderBoard();
    }catch(e){
      toast("–û—à–∏–±–∫–∞: " + e.message);
    }
  }

  async function applyTeam(){
    const t = $("#team2").value.trim() || "Blade Hunters";
    state.team = t;
    localStorage.setItem("bh_team", t);
    toast("–ö–æ–º–∞–Ω–¥–∞: " + t);
    await refreshBoard();
  }
  async function applyTeamFromProfile(){
    const t = $("#team3").value.trim() || "Blade Hunters";
    state.team = t;
    localStorage.setItem("bh_team", t);
    toast("–ö–æ–º–∞–Ω–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –ü–µ—Ä–µ–∑–∞–π–¥–∏, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏–ª–æ—Å—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ.");
    // –î–ª—è MVP –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º /auth
    // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint /me/team, –Ω–æ —Å–µ–π—á–∞—Å –¥–µ—Ä–∂–∏–º –ø—Ä–æ—Å—Ç–æ.
    renderMe();
  }

  function openEdit(id){
    const t = state.trainings.find(x => x.id === id);
    if(!t) return;
    $("#modalTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É";
    const dt = new Date(t.started_at);
    const pad=(n)=>String(n).padStart(2,'0');
    const localDT = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;

    $("#modalBody").innerHTML = `
      <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
      <input id="e_started" type="datetime-local" value="${esc(localDT)}" />

      <div class="row">
        <div style="flex:1">
          <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</label>
          <input id="e_km" value="${esc(t.distance_km)}" />
        </div>
        <div style="flex:1">
          <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
          <input id="e_min" value="${esc(t.duration_min)}" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>–°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)</label>
          <input id="e_spd" value="${esc(t.avg_speed_kmh)}" />
        </div>
        <div style="flex:1">
          <label>–ü—É–ª—å—Å (–æ–ø—Ü.)</label>
          <input id="e_hr" value="${esc(t.avg_hr ?? "")}" />
        </div>
      </div>

      <label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–µ–∫</label>
      <input id="e_url" value="${esc(t.track_url)}" />

      <div class="row" style="margin-top:12px">
        <button class="btn primary" onclick="saveEdit('${esc(id)}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `;
    $("#modalBack").classList.add("show");
  }

  function closeModal(){ $("#modalBack").classList.remove("show"); }

  async function saveEdit(id){
    const startedLocal = $("#e_started").value;
    const km = $("#e_km").value.trim();
    const min = $("#e_min").value.trim();
    const spd = $("#e_spd").value.trim();
    const hr = $("#e_hr").value.trim();
    const url = $("#e_url").value.trim();

    if(!startedLocal) return toast("–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É/–≤—Ä–µ–º—è");
    if(!km || Number(km) <= 0) return toast("–î–∏—Å—Ç–∞–Ω—Ü–∏—è > 0");
    if(!min || Number(min) <= 0) return toast("–ú–∏–Ω—É—Ç—ã > 0");
    if(!spd || Number(spd) <= 0) return toast("–°–∫–æ—Ä–æ—Å—Ç—å > 0");
    if(!url || !url.startsWith("http")) return toast("–°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å http/https");

    const payload = {
      started_at: new Date(startedLocal).toISOString(),
      distance_km: Number(km),
      duration_min: Number(min),
      avg_speed_kmh: Number(spd),
      avg_hr: hr ? Number(hr) : null,
      track_url: url
    };
    try{
      await api("/trainings/" + encodeURIComponent(id), { method:"PUT", body: JSON.stringify(payload) });
      toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
      closeModal();
      await loadTrainings();
      await loadMe();
      render();
    }catch(e){
      toast("–û—à–∏–±–∫–∞: " + e.message);
    }
  }

  async function removeTraining(id){
    if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?")) return;
    try{
      await api("/trainings/" + encodeURIComponent(id), { method:"DELETE" });
      toast("–£–¥–∞–ª–µ–Ω–æ");
      await loadTrainings();
      await loadMe();
      render();
    }catch(e){
      toast("–û—à–∏–±–∫–∞: " + e.message);
    }
  }

  // ===== Tabs wiring =====
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", async () => {
      const tab = t.dataset.tab;
      setTab(tab);
      // lazy refresh
      if(tab === "board") { try{ await loadLeaderboards(); }catch{} renderBoard(); }
      if(tab === "home") { try{ await loadMe(); }catch{} renderHome(); }
      if(tab === "add") { try{ await loadTrainings(); }catch{} renderAdd(); }
      if(tab === "me") { try{ await loadMe(); }catch{} renderMe(); }
    });
  });

  // ===== Boot =====
  (async function boot(){
    await checkHealth();
    const ok = await ensureAuth();
    if(ok){
      try{
        await loadAll();
        toast("–ì–æ—Ç–æ–≤–æ");
      }catch(e){
        toast("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö: " + e.message);
      }
      render();
    }
  })();
</script>
</body>
</html>
